<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
    <script>
    
document.addEventListener('DOMContentLoaded', function () {
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const userRank = localStorage.getItem('userRank');

    if (!isLoggedIn || !['TEACHER', 'SMT', 'ADMINISTRATOR'].includes(userRank)) {
        alert('You must be logged in to view this page.');
        window.location.href = 'index.html'; // Redirect to login page
    }
});
</script>
  
  
  <style>
    body {
      background-color: #dff0d8;
      font-family: Arial, sans-serif;
      font-size: 16px;
    }
    .container {
      max-width: 800px;
      margin-top: 20px;
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    h1, h2 {
      text-align: center;
      color: #3c763d;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .btn-primary {
      background-color: #3c763d;
      border: none;
    }
    .btn-primary:hover {
      background-color: #2e6b2f;
    }
    .result-card {
      display: none;
      margin-top: 30px;
    }
    .card-title {
      color: #3c763d;
    }
    .developer-credit {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #3c763d;
      font-style: italic;
      font-family: "Georgia", serif;
    }
  </style>
  
  <style>
    body.fade-out {
        opacity: 0;
        transition: opacity 0.5s ease-out;
    }

    body.fade-in {
        opacity: 0;
        animation: fadeIn 0.5s ease-in forwards;
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
        }
    }
</style>
  
  
</head>
<body>

    <div class="container">

        <h1>Student Profile</h1>

        <div class="form-group">
            <label for="classes">Classes:</label>
            <input list="class-options" id="classes" class="form-control" onchange="loadStudents()">
            <datalist id="class-options">
                <!-- Options will be dynamically loaded -->
            </datalist>
        </div>



		<div class="form-group">
			<label for="students">Students:</label>
				<div class="input-group">
					<input list="student-options" id="students" class="form-control">
						<datalist id="student-options">
							<!-- Options will be dynamically loaded -->
						</datalist>
					
				</div>

		</div>
				<input type="text" id="studentnid" name="studentnid" class="form-control" readonly hidden />	
		<center><div id="nidStatus" class="text-muted mt-2" style="display: none;">Getting Student NID...</div></center>
		<div class="mt-2">
    <button class="btn btn-primary w-100" onclick="searchStudent()">Search</button>
	</div>
	
	<div class="mt-2">
<button class="btn btn-secondary w-100" onclick="clearForm()">Clear</button>
	</div>
	<div class="mt-3">

		    <button class="btn btn-danger w-100" onclick="navigateToLandingPage()">Back</button>

	</div>

<div class="progress my-3" style="height: 25px; display: none;" id="searchProgressWrapper">
  <div id="searchProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">Searching...</div>
</div>


    <div id="resultCard" class="card result-card">
      <div class="card-header bg-success text-white"><center>Misuse of any document will result in serious concequences.</center></div>
      <div class="card-body" id="studentInfo"></div>
    </div>


  </div>
    <div class="developer-credit">Developed by: Mifthah Ahmed</div>

<script>
function navigateToLandingPage() {
  const rank = localStorage.getItem("userRank");

  if (rank === "TEACHER") {
    navigateWithFade('teachers_landing_page.html');
  } else if (rank === "SMT") {
    navigateWithFade('smt_landing_page.html');
  } else {
    alert("Access denied. Invalid rank.");
    navigateWithFade('index.html'); // Optional: redirect to login
  }
}
</script>


<script>



const phoneNumber = localStorage.getItem('phoneNumber'); // Retrieve the phone number

const teacherScriptUrl = 'https://script.google.com/macros/s/AKfycbyqv1AJXS2gggrPUt82AMLVqpQsoa4fLwiQHb5OgiqkSrGdBxkjkr7R6aHyCCPkXINV/exec';
const classStudentScriptUrl = 'https://script.google.com/macros/s/AKfycbzegnGbhZtUxqycRTeLbjcjrBkYJY5Pe-s-KnZVAvp8rjZ_Etn-5MuEea0O_2B0jCMV/exec';
document.addEventListener('DOMContentLoaded', () => {
  loadClasses();
});

const classScriptUrl = "https://script.google.com/macros/s/AKfycbyCP9RRaEOLXQL8diuejhiCF3Py083hQ9gL0ez4pPHC4fa36p9DeGhBeMn1F7m2VrWG/exec";

function loadClasses() {
  const phoneNumber = localStorage.getItem('phoneNumber');

  fetch(`${classScriptUrl}?action=getClasses&phoneNumber=${encodeURIComponent(phoneNumber)}`)

    .then(response => response.json())
    .then(data => {
      const classList = data.classes.slice(1); // Skip "Class" dummy
      populateClassOptions(classList);
    })
    .catch(error => console.error('Error fetching classes:', error));
}


function populateClassOptions(classes) {
  const classOptions = document.getElementById('class-options');
  classOptions.innerHTML = ''; // Clear previous options

  if (classes.length === 0) {
    const option = document.createElement('option');
    option.value = "No assigned classes";
    classOptions.appendChild(option);
  } else {
    classes.forEach(className => {
      const option = document.createElement('option');
      option.value = className;
      classOptions.appendChild(option);
    });
  }
}





function loadStudents() {
    const className = document.getElementById('classes').value;
    const studentInput = document.getElementById('students');
    const studentOptions = document.getElementById('student-options');

    if (!className) {
        studentOptions.innerHTML = ''; // Clear options if no class selected
		        studentInput.value = ''; // Clear the student input field
        studentInput.style.backgroundColor = ''; // Reset background color
        return;
    }

    studentInput.style.backgroundColor = 'lightcoral'; // Set loading indicator

    fetch(`${classStudentScriptUrl}?action=getStudents&class=${encodeURIComponent(className)}`)
        .then(response => response.json())
        .then(data => {
            studentOptions.innerHTML = ''; // Clear previous options
            data.students.forEach(student => {
                const option = document.createElement('option');
                option.value = `${student.SID} ${student.name}`; // Combine SID and name
                studentOptions.appendChild(option);
            });

            studentInput.style.backgroundColor = 'lightgreen'; // Set success indicator
        })
        .catch(error => {
            console.error('Error fetching students:', error);
            studentInput.style.backgroundColor = ''; // Reset background on error
        });
}


document.getElementById('students').addEventListener('change', function () {
  const studentValue = this.value;
  const indexMatch = studentValue.match(/^(HS\d+)\s+/);
  const nidField = document.getElementById('studentnid');
  const nidStatus = document.getElementById('nidStatus');
  nidStatus.style.display = 'block';
  nidStatus.innerText = 'Getting Student NID...';

  if (!indexMatch) {
    nidField.value = '';
    nidStatus.innerText = 'Invalid selection.';
    return;
  }

  const studentIndex = indexMatch[1];

  fetch(`${classStudentScriptUrl}?action=getStudentNID&index=${encodeURIComponent(studentIndex)}`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        nidField.value = data.nid;
        nidStatus.innerText = 'Student NID received.';
      } else {
        nidField.value = '';
        nidStatus.innerText = 'NID not found.';
      }
    })
    .catch(error => {
      console.error('Error retrieving NID:', error);
      nidField.value = '';
      nidStatus.innerText = 'Error fetching NID.';
    });
});


</script>


  <script>
function searchStudent() {
  const studentId = document.getElementById("studentnid").value;
  const className = document.getElementById("classes").value;
  const infoContainer = document.getElementById("studentInfo");
  const resultCard = document.getElementById("resultCard");

  if (!studentId || !className || studentId === 'Not Found' || studentId === 'Error') {
    alert("Please select a valid student.");
    return;
  }

  const progressWrapper = document.getElementById('searchProgressWrapper');
  const progressBar = document.getElementById('searchProgressBar');
  progressWrapper.style.display = 'block';
  progressBar.style.width = '0%';
  progressBar.innerText = '0%';
  resultCard.style.display = 'none';

  let progress = 0;
  const progressInterval = setInterval(() => {
    if (progress < 95) {
      progress += Math.random() * 2 + 1; // Smooth realistic increase
      progressBar.style.width = `${Math.floor(progress)}%`;
      progressBar.innerText = `${Math.floor(progress)}%`;
    }
  }, 100);

  const endpoint = `https://script.google.com/macros/s/AKfycbyW3byvauBIgA2xQlV-56mOTW9t6CxsoUANEVolzZ1b0TTVOvJ70GUij_XJjRaSGOu3RA/exec?action=searchStudent&studentId=${encodeURIComponent(studentId)}&className=${encodeURIComponent(className)}`;

  fetch(endpoint)
    .then(res => res.json())
    .then(data => {
      clearInterval(progressInterval);
      progressBar.style.width = '100%';
      progressBar.innerText = '100%';

      setTimeout(() => {
        progressWrapper.style.display = 'none';
        if (data.success && data.fileUrl) {
          infoContainer.innerHTML = `
            <div class="text-success mb-2">Student record found:</div>
            <iframe src="${data.fileUrl}" width="100%" height="600" frameborder="0" allowfullscreen></iframe>
          `;
        } else {
          infoContainer.innerHTML = '<div class="text-danger">No student record found.</div>';
        }
        resultCard.style.display = 'block';
      }, 500); // Delay to simulate 100% progress
    })
    .catch(() => {
      clearInterval(progressInterval);
      progressBar.classList.remove('bg-success');
      progressBar.classList.add('bg-danger');
      progressBar.innerText = 'Failed';
      setTimeout(() => {
        progressWrapper.style.display = 'none';
      }, 1000);
      infoContainer.innerHTML = '<div class="text-danger">Error fetching data. Please try again later.</div>';
      resultCard.style.display = 'block';
    });
}

function clearForm() {
  document.getElementById("classes").value = '';
  document.getElementById("students").value = '';
  document.getElementById("studentnid").value = '';
  document.getElementById("studentnid").style.backgroundColor = '';
  document.getElementById("studentInfo").innerHTML = '';
  document.getElementById("resultCard").style.display = 'none';
  document.getElementById("searchProgressWrapper").style.display = 'none';
  document.getElementById("nidStatus").style.display = 'none'; 
  document.getElementById("nidStatus").innerText = '';        
}


</script>


<script>
    // When the page loads, fade in
    document.addEventListener("DOMContentLoaded", () => {
        document.body.classList.add("fade-in");
    });

    // Smooth navigation handler
    function navigateWithFade(url) {
        document.body.classList.remove("fade-in");
        document.body.classList.add("fade-out");

        setTimeout(() => {
            window.location.href = url;
        }, 500); // Match the transition time
    }
</script>


</body>
</html>
